(()=>{"use strict";(()=>{let e;window.utils={isEscEvent:(e,t)=>{"Escape"===e.key&&(e.preventDefault(),t())},debounce:t=>{e&&window.clearTimeout(e),e=window.setTimeout(t,500)}}})(),(()=>{const e="GET",t="POST";let o=(e,t,o,r,n)=>{let a=new XMLHttpRequest;switch(a.responseType="json",a.addEventListener("load",(()=>{200===a.status?o(a.response):r("Произошла ошибка. Статус ответа: "+a.status)})),a.addEventListener("error",(()=>{r("Произошла ошибка соединения")})),a.addEventListener("timeout",(()=>{r("Запрос не успел выполниться за 10000 мс")})),a.open(e,t),e){case"GET":a.send();break;case"POST":a.send(n);break;default:a.send()}};window.backend={load:(t,r)=>{o(e,"https://21.javascript.pages.academy/keksobooking/data",t,r)},upload:(e,r,n)=>{o(t,"https://21.javascript.pages.academy/keksobooking",r,n,e)}}})(),(()=>{const e="any",t=document.querySelector(".map"),o=t.querySelector(".map__filters"),r=o.querySelectorAll("select"),n=o.querySelector("#housing-type"),a=o.querySelector("#housing-price"),d=o.querySelector("#housing-rooms"),l=o.querySelector("#housing-guests"),i=o.querySelectorAll('input[type="checkbox"]'),s=5e4,u=1e4,c="high",p="middle",m="low";window.data={ads:[],maxPinsAmount:5,downloadedData:null,onSuccessLoadRequest:e=>{window.data.ads=e,window.data.downloadedData=e,window.map.renderPins(),f()},onErrorLoadRequest:e=>{let t=document.createElement("div");t.style="z-index: 100; margin: 0 auto; text-align: center; background-color: red;",t.style.position="fixed",t.style.left=0,t.style.right=0,t.style.fontSize="30px",t.textContent=e,document.body.insertAdjacentElement("afterbegin",t)}};let f=()=>{if(t.querySelectorAll(".map__pin").length>1){for(let e of i)e.removeAttribute("disabled");for(let e of r)e.removeAttribute("disabled")}},y=()=>{window.map.removePins(),window.map.removeCard(),window.map.renderPins()};o.addEventListener("change",(()=>{let t=[];for(let e of i)e.checked&&t.push(e.value);let o=window.data.downloadedData.filter((o=>{let r;return r=o.offer.price>s?c:o.offer.price<u?m:p,(o.offer.type===n.value||n.value===e)&&(r===a.value||a.value===e)&&(o.offer.rooms===Number(d.value)||d.value===e)&&(o.offer.guests===Number(l.value)||l.value===e)&&((e,t)=>{let o=!0;return t.forEach((t=>{-1===e.indexOf(t)&&(o=!1)})),o})(o.offer.features,t)}));window.data.ads=o,window.utils.debounce(y)}))})(),(()=>{const e=document.querySelector(".map").querySelector(".map__pin--main"),t=e.offsetWidth/2,o=e.offsetHeight/2,r=document.querySelector(".ad-form"),n=r.querySelector(".ad-form__photo"),a=r.querySelector(".ad-form-header__preview img"),d=r.querySelector("#address"),l=document.querySelector(".ad-form__reset"),i=r.querySelector("#room_number"),s=r.querySelector("#capacity"),u=r.querySelector("#title"),c=u.getAttribute("maxlength"),p=u.getAttribute("minlength"),m=r.querySelector("#price"),f=r.querySelector("#type"),y={bungalow:0,flat:1e3,house:5e3,palace:1e4};window.form={getStartMainPinCoords:()=>{d.value=`${Math.round(parseInt(e.style.left,10)+t)},\n${Math.round(parseInt(e.style.top,10)+o)}`},getMainPinCoords:()=>{d.value=`${Math.round(parseInt(e.style.left,10)+t)},\n${Math.round(parseInt(e.style.top,10)+80)}`}};const v=r.querySelector("#timein"),w=r.querySelector("#timeout"),g=document.querySelector("#success").content.querySelector(".success"),S=document.querySelector("#error").content.querySelector(".error"),q=document.querySelector("main");let _=()=>{let e=i.value,t=s.value;100===Number(e)&&0!==Number(t)?s.setCustomValidity('Для выбранного значения Количество комнат: "100 комнат" подходит только вариант "Не для гостей"'):0===Number(t)&&100!==Number(e)?s.setCustomValidity('Вариант "Не для гостей" подходит только для "100 комнат"'):Number(e)<Number(t)?s.setCustomValidity(`Количество гостей не соответствует количеству комнат. Для данного варианта количество гостей не должно превышать: ${Number(e)} `):s.setCustomValidity(""),s.reportValidity()};s.addEventListener("change",(()=>{_()})),i.addEventListener("change",(()=>{_()})),u.addEventListener("input",(()=>{let e=u.value.length;e<p?u.setCustomValidity(`Ещё ${p-e} симв.`):e>c?u.setCustomValidity(`Удалите ${e-c} симв.`):u.setCustomValidity(""),u.reportValidity()}));let h=()=>{let e=f.options[f.selectedIndex];m.value<y[f.value]?m.setCustomValidity(`Минимальная цена за жилье класса "${e.textContent}": ${y[f.value]}`):m.setCustomValidity(""),m.reportValidity()};m.addEventListener("input",(()=>{h()})),f.addEventListener("change",(()=>{m.setAttribute("min",y[f.value]),m.setAttribute("placeholder",y[f.value]),h()})),v.addEventListener("change",(()=>{w.value=v.value})),w.addEventListener("change",(()=>{v.value=w.value}));let b=g.cloneNode(!0),E=S.cloneNode(!0),L=e=>{window.utils.isEscEvent(e,x)},k=e=>{e.preventDefault(),x()},x=()=>{b.remove(),E.remove(),document.removeEventListener("keydown",L),document.removeEventListener("click",k)},C=e=>{q.append(e),document.addEventListener("keydown",L),e.addEventListener("click",k)},P=()=>{a.src="img/muffin-grey.svg"},A=()=>{n.innerHTML=""},M=()=>{C(b),r.reset(),P(),A(),window.main.deactivationPage()},D=()=>{C(E)};r.addEventListener("submit",(e=>{e.preventDefault(),window.backend.upload(new FormData(r),M,D)})),l.addEventListener("click",(e=>{e.preventDefault(),r.reset(),P(),A(),window.main.deactivationPage()}))})(),(()=>{const e=["gif","jpg","jpeg","png"],t=document.querySelector(".ad-form"),o=t.querySelector("#avatar"),r=t.querySelector(".ad-form-header__preview img"),n=t.querySelector("#images"),a=t.querySelector(".ad-form__photo");let d=(t,o)=>{t.addEventListener("change",(()=>{let r=t.files[0],n=r.name.toLowerCase();if(e.some((e=>n.endsWith(e)))){let e=new FileReader;e.addEventListener("load",(()=>{if("IMG"===o.tagName)o.src=e.result;else{o.innerHTML="",o.style=" display:flex; justify-content:center;align-items:center;";let t=document.createElement("img");t.src=e.result,t.alt="Превью загруженной фотографии",t.style=" max-width:100%; width:100%;",o.append(t)}})),e.readAsDataURL(r)}}))};d(o,r),d(n,a)})(),(()=>{const e=document.querySelector("#pin").content.querySelector(".map__pin");window.pin={renderPin:t=>{if(t.offer){let o=e.cloneNode(!0);o.style.left=t.location.x-25+"px",o.style.top=t.location.y-70+"px";let r=o.querySelector("img");return r.src=t.author.avatar,r.alt=t.offer.title,o.addObj=t,o}}}})(),(()=>{const e=document.querySelector("#card").content.querySelector(".popup"),t={flat:"Квартира",bungalow:"Бунгало",house:"Дом",palace:"Дворец"};window.card={renderCard:o=>{let r=e.cloneNode(!0),n=r.querySelector(".popup__title");o.offer.title?n.textContent=o.offer.title:n.remove();let a=r.querySelector(".popup__text--address");o.offer.address?a.textContent=o.offer.address:a.remove();let d=r.querySelector(".popup__text--price");o.offer.price?d.textContent=o.offer.price+"₽/ночь":d.remove();let l=r.querySelector(".popup__type");o.offer.type?l.textContent=t[o.offer.type]:l.remove();let i=r.querySelector(".popup__text--capacity"),s="";if(o.offer.rooms)switch(o.offer.rooms){case 1:s=o.offer.rooms+" комната";break;case 35:case 100:s=o.offer.rooms+" комнат";break;default:s=o.offer.rooms+" комнаты"}let u="";o.offer.guests&&(u=1===o.offer.guests?`для ${o.offer.guests} гостя`:`для ${o.offer.guests} гостей`),i.textContent=`${s} ${u}`;let c=r.querySelector(".popup__text--time"),p=o.offer.checkin?`Заезд после ${o.offer.checkin},`:"",m=o.offer.checkout?"выезд&nbsp;до "+o.offer.checkout:"";c.innerHTML=`${p} ${m}`;let f=r.querySelector(".popup__features");f.innerHTML="",o.offer.features?o.offer.features.forEach((e=>{let t=document.createElement("li");t.classList.add("popup__feature","popup__feature--"+e),f.append(t)})):f.remove();let y=r.querySelector(".popup__description");o.offer.description?y.textContent=o.offer.description:y.remove();let v=r.querySelector(".popup__photos"),w=v.querySelector(".popup__photo");v.innerHTML="",o.offer.photos?o.offer.photos.forEach((e=>{let t=w.cloneNode(!0);t.src=e,v.append(t)})):v.remove();let g=r.querySelector(".popup__avatar");return o.author.avatar?g.src=o.author.avatar:g.remove(),r}}})(),(()=>{const e=document.querySelector(".map__filters-container"),t=document.querySelector(".map"),o=t.querySelector(".map__pins");let r=null,n=()=>{r.remove(),document.removeEventListener("keydown",a)},a=e=>{window.utils.isEscEvent(e,n)},d=o=>{let d=o.target.closest(".map__pin"),l=o.target.closest(".map__pin--main");if(d&&!l){let o=t.querySelector(".map__card");o&&o.remove(),r=window.card.renderCard(d.addObj),e.before(r),r.querySelector(".popup__close").addEventListener("click",(()=>{n()})),document.addEventListener("keydown",a)}};window.map={renderPins:()=>{o.append((e=>{let t=document.createDocumentFragment(),o=e.length>window.data.maxPinsAmount?window.data.maxPinsAmount:e.length;for(let r=0;r<o;r++)window.pin.renderPin(e[r])&&t.append(window.pin.renderPin(e[r]));return t})(window.data.ads))},removePins:()=>{let e=o.children;for(let t=e.length-1;t>=0;t--)e[t].classList.contains("map__pin")&&!e[t].classList.contains("map__pin--main")&&e[t].remove()},renderCardOnClick:()=>{o.addEventListener("click",(e=>{d(e)}))},renderCardOnEnter:()=>{t.addEventListener("keydown",(e=>{"Enter"===e.key&&(e.preventDefault(),d(e))}))},removeCard:()=>{let e=t.querySelector(".map__card");e&&(e.remove(),document.removeEventListener("keydown",a))}}})(),(()=>{const e=document.querySelector(".map"),t=e.querySelector(".map__pin--main"),o=document.querySelector(".ad-form"),r=document.querySelector(".map__filters"),n=o.querySelectorAll("fieldset"),a=r.querySelectorAll("select"),d=r.querySelectorAll('input[type="checkbox"]');let l=()=>{e.classList.add("map--faded"),o.classList.add("ad-form--disabled");for(let e of n)e.setAttribute("disabled","disabled");for(let e of d)e.checked=!1,e.setAttribute("disabled","disabled");for(let e of a)e.value="any",e.setAttribute("disabled","disabled");t.style.cssText="left: 570px; top: 375px;",t.addEventListener("mousedown",(e=>{e.preventDefault(),0===e.button&&(i(),window.form.getMainPinCoords())}),{once:!0}),t.addEventListener("keydown",(e=>{"Enter"===e.key&&(e.preventDefault(),i(),window.form.getMainPinCoords())}),{once:!0}),window.form.getStartMainPinCoords(),window.map.removePins(),window.map.removeCard()};l();let i=()=>{window.backend.load(window.data.onSuccessLoadRequest,window.data.onErrorLoadRequest),e.classList.remove("map--faded"),o.classList.remove("ad-form--disabled");for(let e of n)e.removeAttribute("disabled")};window.map.renderCardOnClick(),window.map.renderCardOnEnter(),window.main={deactivationPage:l}})(),(()=>{const e=document.querySelector(".map"),t=e.querySelector(".map__pin--main"),o=e.getBoundingClientRect(),r=t.offsetWidth/2,n=0-r,a=e.clientWidth-r,d=130+t.offsetHeight;t.addEventListener("mousedown",(e=>{e.preventDefault();let l={x:e.clientX,y:e.clientY},i=e=>{e.preventDefault();let i=l.x-e.clientX,s=l.y-e.clientY;l={x:e.clientX,y:e.clientY},e.clientY<d-pageYOffset?t.style.top=d-pageYOffset:e.clientY>630-pageYOffset?t.style.top=630-pageYOffset:t.style.top=t.offsetTop-s+"px",e.clientX<o.left+r?t.style.left=n:e.clientX>o.right?t.style.left=a+"px":t.style.left=t.offsetLeft-i+"px",window.form.getMainPinCoords()},s=e=>{e.preventDefault(),document.removeEventListener("mousemove",i),document.removeEventListener("mouseup",s),window.form.getMainPinCoords()};document.addEventListener("mousemove",i),document.addEventListener("mouseup",s)}))})()})();