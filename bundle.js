(()=>{"use strict";(()=>{let e;window.utils={getRandomNumber(e,t){let o=e+Math.random()*(t+1-e);return Math.floor(o)},shuffleArray(e){for(let t=e.length-1;t>0;t--){let o=Math.floor(Math.random()*(t+1));[e[t],e[o]]=[e[o],e[t]]}return e},isEscEvent(e,t){"Escape"===e.key&&(e.preventDefault(),t())},debounce(t){e&&window.clearTimeout(e),e=window.setTimeout(t,500)}}})(),(()=>{const e="GET",t="POST";let o=(e,t,o,r,n)=>{let a=new XMLHttpRequest;switch(a.responseType="json",a.addEventListener("load",(()=>{200===a.status?o(a.response):r("Произошла ошибка. Статус ответа: "+a.status)})),a.addEventListener("error",(()=>{r("Произошла ошибка соединения")})),a.addEventListener("timeout",(()=>{r("Запрос не успел выполниться за 10000 мс")})),a.open(e,t),e){case"GET":a.send();break;case"POST":a.send(n);break;default:a.send()}};window.backend={load(t,r){o(e,"https://21.javascript.pages.academy/keksobooking/data",t,r)},upload(e,r,n){o(t,"https://21.javascript.pages.academy/keksobooking",r,n,e)}}})(),(()=>{const e="any",t=document.querySelector(".map"),o=t.querySelector(".map__filters"),r=o.querySelectorAll("select"),n=o.querySelector("#housing-type"),a=o.querySelector("#housing-price"),d=o.querySelector("#housing-rooms"),l=o.querySelector("#housing-guests"),i=o.querySelectorAll('input[type="checkbox"]'),s=5e4,u=1e4,c="high",p="middle",m="low";window.data={ads:[],maxPinsAmount:5,downloadedData:null,successLoadRequestHandler(e){window.data.ads=e,window.data.downloadedData=e,window.map.renderPins(),f()},errorLoadRequestHandler(e){let t=document.createElement("div");t.style="z-index: 100; margin: 0 auto; text-align: center; background-color: red;",t.style.position="fixed",t.style.left=0,t.style.right=0,t.style.fontSize="30px",t.textContent=e,document.body.insertAdjacentElement("afterbegin",t)}};let f=()=>{if(t.querySelectorAll(".map__pin").length>1){for(let e of i)e.removeAttribute("disabled");for(let e of r)e.removeAttribute("disabled")}},y=()=>{window.map.removePins(),window.map.removeCard(),window.map.renderPins()};o.addEventListener("change",(()=>{let t=[];for(let e of i)e.checked&&t.push(e.value);let o=window.data.downloadedData.filter((o=>{let r;return r=o.offer.price>s?c:o.offer.price<u?m:p,(o.offer.type===n.value||n.value===e)&&(r===a.value||a.value===e)&&(o.offer.rooms===Number(d.value)||d.value===e)&&(o.offer.guests===Number(l.value)||l.value===e)&&((e,t)=>{let o=!0;return t.forEach((t=>{-1===e.indexOf(t)&&(o=!1)})),o})(o.offer.features,t)}));window.data.ads=o,window.utils.debounce(y)}))})(),(()=>{const e=document.querySelector(".map").querySelector(".map__pin--main"),t=e.offsetWidth/2,o=e.offsetHeight/2,r=document.querySelector(".ad-form"),n=r.querySelector("#address"),a=document.querySelector(".ad-form__reset"),d=r.querySelector("#room_number"),l=r.querySelector("#capacity"),i=r.querySelector("#title"),s=i.getAttribute("maxlength"),u=i.getAttribute("minlength"),c=r.querySelector("#price"),p=r.querySelector("#type"),m={bungalow:0,flat:1e3,house:5e3,palace:1e4};window.form={getStartMainPinCoords(){n.value=`${Math.round(parseInt(e.style.left,10)+t)},\n${Math.round(parseInt(e.style.top,10)+o)}`},getMainPinCoords(){n.value=`${Math.round(parseInt(e.style.left,10)+t)},\n${Math.round(parseInt(e.style.top,10)+80)}`}};const f=r.querySelector("#timein"),y=r.querySelector("#timeout"),v=document.querySelector("#success").content.querySelector(".success"),w=document.querySelector("#error").content.querySelector(".error"),h=document.querySelector("main");let g=()=>{let e=d.value,t=l.value;100===Number(e)&&0!==Number(t)?l.setCustomValidity('Для выбранного значения Количество комнат: "100 комнат" подходит только вариант "Не для гостей"'):0===Number(t)&&100!==Number(e)?l.setCustomValidity('Вариант "Не для гостей" подходит только для "100 комнат"'):Number(e)<Number(t)?l.setCustomValidity(`Количество гостей не соответствует количеству комнат. Для данного варианта количество гостей не должно превышать: ${Number(e)} `):l.setCustomValidity(""),l.reportValidity()};l.addEventListener("change",(()=>{g()})),d.addEventListener("change",(()=>{g()})),i.addEventListener("input",(()=>{let e=i.value.length;e<u?i.setCustomValidity(`Ещё ${u-e} симв.`):e>s?i.setCustomValidity(`Удалите ${e-s} симв.`):i.setCustomValidity(""),i.reportValidity()}));let q=()=>{let e=p.options[p.selectedIndex];c.value<m[p.value]?c.setCustomValidity(`Минимальная цена за жилье класса "${e.textContent}": ${m[p.value]}`):c.setCustomValidity(""),c.reportValidity()};c.addEventListener("input",(()=>{q()})),p.addEventListener("change",(()=>{c.setAttribute("min",m[p.value]),c.setAttribute("placeholder",m[p.value]),q()})),f.addEventListener("change",(()=>{y.value=f.value})),y.addEventListener("change",(()=>{f.value=y.value}));let S=v.cloneNode(!0),_=w.cloneNode(!0),b=e=>{window.utils.isEscEvent(e,L)},E=e=>{e.preventDefault(),L()},L=()=>{S.remove(),_.remove(),document.removeEventListener("keydown",b),document.removeEventListener("click",E)},k=e=>{h.append(e),document.addEventListener("keydown",b),e.addEventListener("click",E)},C=()=>{k(S),r.reset(),window.main.deactivationPage()},x=()=>{k(_)};r.addEventListener("submit",(e=>{e.preventDefault(),window.backend.upload(new FormData(r),C,x)})),a.addEventListener("click",(e=>{e.preventDefault(),r.reset(),window.main.deactivationPage()}))})(),(()=>{const e=document.querySelector("#pin").content.querySelector(".map__pin");window.pin={renderPin(t){if(t.offer){let o=e.cloneNode(!0);o.style.left=t.location.x-25+"px",o.style.top=t.location.y-70+"px";let r=o.querySelector("img");return r.src=t.author.avatar,r.alt=t.offer.title,o.addObj=t,o}}}})(),(()=>{const e=document.querySelector("#card").content.querySelector(".popup"),t={flat:"Квартира",bungalow:"Бунгало",house:"Дом",palace:"Дворец"};window.card={renderCard(o){let r=e.cloneNode(!0),n=r.querySelector(".popup__title");o.offer.title?n.textContent=o.offer.title:n.remove();let a=r.querySelector(".popup__text--address");o.offer.address?a.textContent=o.offer.address:a.remove();let d=r.querySelector(".popup__text--price");o.offer.price?d.textContent=o.offer.price+"₽/ночь":d.remove();let l=r.querySelector(".popup__type");o.offer.type?l.textContent=t[o.offer.type]:l.remove();let i=r.querySelector(".popup__text--capacity"),s="";if(o.offer.rooms)switch(o.offer.rooms){case 1:s=o.offer.rooms+" комната";break;case 35:case 100:s=o.offer.rooms+" комнат";break;default:s=o.offer.rooms+" комнаты"}let u="";o.offer.guests&&(u=1===o.offer.guests?`для ${o.offer.guests} гостя`:`для ${o.offer.guests} гостей`),i.textContent=`${s} ${u}`;let c=r.querySelector(".popup__text--time"),p=o.offer.checkin?`Заезд после ${o.offer.checkin},`:"",m=o.offer.checkout?"выезд&nbsp;до "+o.offer.checkout:"";c.innerHTML=`${p} ${m}`;let f=r.querySelector(".popup__features");f.innerHTML="",o.offer.features?o.offer.features.forEach((e=>{let t=document.createElement("li");t.classList.add("popup__feature","popup__feature--"+e),f.append(t)})):f.remove();let y=r.querySelector(".popup__description");o.offer.description?y.textContent=o.offer.description:y.remove();let v=r.querySelector(".popup__photos"),w=v.querySelector(".popup__photo");v.innerHTML="",o.offer.photos?o.offer.photos.forEach((e=>{let t=w.cloneNode(!0);t.src=e,v.append(t)})):v.remove();let h=r.querySelector(".popup__avatar");return o.author.avatar?h.src=o.author.avatar:h.remove(),r}}})(),(()=>{const e=document.querySelector(".map__filters-container"),t=document.querySelector(".map"),o=t.querySelector(".map__pins");let r=null,n=()=>{r.remove(),document.removeEventListener("keydown",a)},a=e=>{window.utils.isEscEvent(e,n)},d=o=>{let d=o.target.closest(".map__pin"),l=o.target.closest(".map__pin--main");if(d&&!l){let o=t.querySelector(".map__card");o&&o.remove(),r=window.card.renderCard(d.addObj),e.before(r),r.querySelector(".popup__close").addEventListener("click",(()=>{n()})),document.addEventListener("keydown",a)}};window.map={renderPins(){o.append((e=>{let t=document.createDocumentFragment(),o=e.length>window.data.maxPinsAmount?window.data.maxPinsAmount:e.length;for(let r=0;r<o;r++)window.pin.renderPin(e[r])&&t.append(window.pin.renderPin(e[r]));return t})(window.data.ads))},removePins(){let e=o.children;for(let t=e.length-1;t>=0;t--)e[t].classList.contains("map__pin")&&!e[t].classList.contains("map__pin--main")&&e[t].remove()},renderCardOnClick(){o.addEventListener("click",(e=>{d(e)}))},renderCardOnEnter(){t.addEventListener("keydown",(e=>{"Enter"===e.key&&(e.preventDefault(),d(e))}))},removeCard(){let e=t.querySelector(".map__card");e&&(e.remove(),document.removeEventListener("keydown",a))}}})(),(()=>{const e=document.querySelector(".map"),t=e.querySelector(".map__pin--main"),o=document.querySelector(".ad-form"),r=document.querySelector(".map__filters"),n=o.querySelectorAll("fieldset"),a=r.querySelectorAll("select"),d=r.querySelectorAll('input[type="checkbox"]');let l=()=>{e.classList.add("map--faded"),o.classList.add("ad-form--disabled");for(let e of n)e.setAttribute("disabled","disabled");for(let e of d)e.checked=!1,e.setAttribute("disabled","disabled");for(let e of a)e.value="any",e.setAttribute("disabled","disabled");t.addEventListener("mousedown",(e=>{e.preventDefault(),0===e.button&&(i(),window.form.getMainPinCoords())}),{once:!0}),t.addEventListener("keydown",(e=>{"Enter"===e.key&&(e.preventDefault(),i(),window.form.getMainPinCoords())}),{once:!0}),window.form.getStartMainPinCoords(),window.map.removePins(),window.map.removeCard()};l();let i=()=>{window.backend.load(window.data.successLoadRequestHandler,window.data.errorLoadRequestHandler),e.classList.remove("map--faded"),o.classList.remove("ad-form--disabled");for(let e of n)e.removeAttribute("disabled")};window.map.renderCardOnClick(),window.map.renderCardOnEnter(),window.main={deactivationPage(){l()}}})(),(()=>{const e=document.querySelector(".map"),t=e.querySelector(".map__pin--main"),o=e.getBoundingClientRect(),r=t.offsetWidth/2,n=0-r,a=e.clientWidth-r,d=130+t.offsetHeight;t.addEventListener("mousedown",(e=>{e.preventDefault();let l={x:e.clientX,y:e.clientY},i=e=>{e.preventDefault();let i=l.x-e.clientX,s=l.y-e.clientY;l={x:e.clientX,y:e.clientY},e.clientY<d-pageYOffset?t.style.top=d-pageYOffset:e.clientY>630-pageYOffset?t.style.top=630-pageYOffset:t.style.top=t.offsetTop-s+"px",e.clientX<o.left+r?t.style.left=n:e.clientX>o.right?t.style.left=a+"px":t.style.left=t.offsetLeft-i+"px",window.form.getMainPinCoords()},s=e=>{e.preventDefault(),document.removeEventListener("mousemove",i),document.removeEventListener("mouseup",s),window.form.getMainPinCoords()};document.addEventListener("mousemove",i),document.addEventListener("mouseup",s)}))})()})();